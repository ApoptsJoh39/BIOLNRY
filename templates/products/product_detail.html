{% extends 'base.html' %}

{% block title %}{{ product.name }} - Marketplace{% endblock %}

{% block content %}
<style>
  /* Estilos para selecci√≥n de tallas y colores */
  .option-btn {
    transition: all 0.2s ease-in-out;
    border: 2px solid transparent;
  }
  .option-btn.selected {
    border-color: #FFC107; /* Un color de acento, puedes cambiarlo */
    box-shadow: 0 0 5px rgba(255, 193, 7, 0.5);
  }
  .option-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  
  /* Colores crema/dorado */
  .bg-cream-100 { background-color: #FFF8E1; }
  .bg-cream-600 { background-color: #FFC107; }
  .text-cream-700 { color: #FFA000; }
  .border-cream-500 { border-color: #FFCA28; }
  .hover\:bg-cream-600:hover { background-color: #FFC107; }
  .focus\:ring-cream-500:focus { --tw-ring-color: #FFCA28; }
  
  /* Colores rojo */
  .bg-red-700 { background-color: #4c0909; }
  
  /* Colores azul claro */
  .bg-lightblue-400 { background-color: #4ff7e3; }
  .bg-lightblue-100 { background-color: #E1F5FE; }
  .bg-lightblue-200 { background-color: #B3E5FC; }
  .bg-lightblue-300 { background-color: #81D4FA; }
  .bg-lightblue-400 { background-color: #4ff7e3; }
  .bg-lightblue-500 { background-color: #29B6F6; }
  .bg-lightblue-600 { background-color: #03A9F4; }
  .text-lightblue-600 { color: #03A9F4; }
  .text-lightblue-700 { color: #0288D1; }
  .border-lightblue-400 { border-color: #4FC3F7; }
  .border-lightblue-500 { border-color: #29B6F6; }
  .hover\:bg-lightblue-500:hover { background-color: #29B6F6; }
  .hover\:bg-lightblue-600:hover { background-color: #03A9F4; }
  .hover\:text-lightblue-600:hover { color: #03A9F4; }
  .focus\:ring-lightblue-500:focus { --tw-ring-color: #29B6F6; }

</style>

<section class="py-8">
    <div class="container mx-auto px-4">
        <!-- Breadcrumbs -->
        <nav class="text-sm mb-6" aria-label="Breadcrumb">
            <ol class="flex items-center space-x-2">
                <li><a href="{% url 'home' %}" class="text-gray-500 hover:text-primary-600">Home</a></li>
                <li><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                <li><a href="{% url 'product_list' %}" class="text-gray-500 hover:text-primary-600">Products</a></li>
                <li><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                <li><a href="{% url 'product_list_by_category' product.category.slug %}" class="text-gray-500 hover:text-primary-600">{{ product.category.name }}</a></li>
                <li><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" /></svg></li>
                <li class="text-gray-700 font-medium">{{ product.name }}</li>
            </ol>
        </nav>
        
        <div class="bg-black rounded-lg shadow-sm overflow-hidden">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 p-6">
                <!-- Product Image -->
                <div class="bg-red-700 rounded-lg flex items-center justify-center overflow-hidden">
                    {% if product.image %}
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="object-contain max-h-96 w-full">
                    {% else %}
                        <div class="flex items-center justify-center h-96 w-full bg-gray-200 text-gray-400">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                        </div>
                    {% endif %}
                </div>
                
                <!-- Product Info -->
                <div class="flex flex-col">
                    <h1 class="text-3xl font-heading font-bold text-gray-900 mb-2">{{ product.name }}</h1>
                    <div class="mb-4">
                        <span class="text-xl font-semibold text-gray-900">${{ price|floatformat:2 }}</span>
                        {% if user_type == 'guest' %}<span class="inline-flex items-center ml-3 px-2.5 py-0.5 rounded-full text-xs font-medium bg-warning-100 text-warning-800">Guest Price (+10%)</span>{% endif %}
                        {% if user_type == 'business' %}<span class="inline-flex items-center ml-3 px-2.5 py-0.5 rounded-full text-xs font-medium bg-accent-100 text-accent-800">Business Discount (25% Off)</span>{% endif %}
                    </div>
                    
                    {% if not user.is_authenticated %}<div class="mb-6 p-3 bg-warning-50 text-warning-800 text-sm rounded-md border border-warning-200"><p>You're seeing guest prices. <a href="{% url 'account_signup' %}" class="font-medium underline">Sign up</a> for better prices!</p></div>{% endif %}
                    
                    <div class="mb-6"><h3 class="text-lg font-semibold mb-2">Description</h3><p class="text-gray-600">{{ product.description }}</p></div>
                    <div class="mb-6"><h3 class="text-lg font-semibold mb-2">Availability</h3>{% if product.stock > 0 %}<div class="flex items-center"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-success-100 text-success-800">In Stock</span><span class="text-gray-500 text-sm ml-2">{{ product.stock }} available</span></div>{% else %}<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-error-100 text-error-800">Out of Stock</span>{% endif %}</div>
                    <div class="mb-6"><h3 class="text-lg font-semibold mb-2">Shipping</h3><p class="text-black-600">Delivery within 15-30 business days</p></div>

                    {% if product.stock > 0 %}
                        <form method="post" action="{% url 'add_to_cart' product.id %}" class="mt-auto" onsubmit="return validateSelection(event)">
                            {% csrf_token %}

                            {% with category_slug=product.category.slug %}
                            {% if category_slug != 'maquinas-y-herramientas' and category_slug != 'business-opportunity' %}
                                <!-- Size Selection -->
                                {% if product.sizes.all %}
                                <div class="mb-4">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Size</h3>
                                    <div class="flex flex-wrap gap-2" id="size-options">
                                        {% for size in product.sizes.all %}
                                        <button type="button" data-value="{{ size.name }}" class="option-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md">
                                            {{ size.name }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" name="size" id="selected_size">
                                </div>
                                {% endif %}

                                <!-- Color Selection -->
                                {% if product.colors.all %}
                                <div class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-800 mb-2">Color</h3>
                                    <div class="flex flex-wrap gap-2" id="color-options">
                                        {% for color in product.colors.all %}
                                        <button type="button" data-value="{{ color.name }}" class="option-btn bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-md">
                                            {{ color.name }}
                                        </button>
                                        {% endfor %}
                                    </div>
                                    <input type="hidden" name="color" id="selected_color">
                                </div>
                                {% endif %}
                            {% endif %}
                            {% endwith %}

                            <div class="flex mb-4 items-end">
                                <div class="w-1/3 mr-4">
                                    <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">Quantity</label>
                                    <input type="number" name="quantity" id="quantity" min="1" max="{{ product.stock }}" value="1" class="w-full rounded-md border-gray-300 shadow-sm focus:border-primary-300 focus:ring focus:ring-primary-200 focus:ring-opacity-50">
                                </div>
                                <div class="flex-grow">
                                    <button type="submit" class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-black bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                        Add to Cart
                                    </button>
                                </div>
                            </div>
                        </form>
                    {% else %}
                        <button disabled class="w-full md:w-auto flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-black bg-gray-400 cursor-not-allowed">Out of Stock</button>
                    {% endif %}
                </div>
            </div>
        </div>
        <!-- Related Products, etc. -->
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sizeOptions = document.getElementById('size-options');
    const colorOptions = document.getElementById('color-options');
    const selectedSizeInput = document.getElementById('selected_size');
    const selectedColorInput = document.getElementById('selected_color');

    if (sizeOptions) {
        sizeOptions.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') {
                // Remove selected class from all size buttons
                sizeOptions.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                // Add selected class to the clicked button
                e.target.classList.add('selected');
                // Update hidden input
                selectedSizeInput.value = e.target.dataset.value;
            }
        });
    }

    if (colorOptions) {
        colorOptions.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') {
                // Remove selected class from all color buttons
                colorOptions.querySelectorAll('button').forEach(btn => btn.classList.remove('selected'));
                // Add selected class to the clicked button
                e.target.classList.add('selected');
                // Update hidden input
                selectedColorInput.value = e.target.dataset.value;
            }
        });
    }
});

function validateSelection(event) {
    const sizeOptions = document.getElementById('size-options');
    const colorOptions = document.getElementById('color-options');
    const selectedSize = document.getElementById('selected_size').value;
    const selectedColor = document.getElementById('selected_color').value;

    // Check if size selection exists and if a size has been selected
    if (sizeOptions && !selectedSize) {
        alert('Please select a size.');
        event.preventDefault(); // Stop form submission
        return false;
    }

    // Check if color selection exists and if a color has been selected
    if (colorOptions && !selectedColor) {
        alert('Please select a color.');
        event.preventDefault(); // Stop form submission
        return false;
    }

    return true; // Allow form submission
}
</script>
{% endblock %}
