{% extends 'base.html' %}

{% block title %}Checkout - Marketplace{% endblock %}

{% block extra_css %}
<style>
    /* Stripe Elements custom styling */
    .StripeElement {
        box-sizing: border-box;
        height: 40px;
        padding: 10px 12px;
        border: 1px solid #e2e8f0;
        border-radius: 0.375rem;
        background-color: white;
        box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        transition: box-shadow 150ms ease;
    }

    .StripeElement--focus {
        box-shadow: 0 0 0 2px #bfdbfe;
    }

    .StripeElement--invalid {
        border-color: #fb7185;
    }

    .StripeElement--webkit-autofill {
        background-color: #fefde5 !important;
    }
    
    /* Estilo mejorado para el botón de submit */
    #submit-button {
        background-color: #000;
        border-color: #000;
    }
    #submit-button:hover {
        background-color: #333;
        border-color: #333;
    }
    #submit-button:disabled {
        opacity: 0.7;
        cursor: not-allowed;
    }
    #spinner {
        display: none;
        margin-left: 8px;
    }
    
    /* Estilos para direcciones */
    .address-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }
    .address-card:hover {
        border-color: #3b82f6;
    }
    .address-card.selected {
        border-color: #3b82f6;
        background-color: #eff6ff;
    }
    .error-message {
        color: #ef4444;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }
    <style>
  /* Colores crema/dorado */
  .bg-cream-100 { background-color: #FFF8E1; }
  .bg-cream-200 { background-color: #FFECB3; }
  .bg-cream-300 { background-color: #FFE082; }
  .bg-cream-400 { background-color: #FFD54F; }
  .bg-cream-500 { background-color: #FFCA28; }
  .bg-cream-600 { background-color: #FFC107; }
  .text-cream-600 { color: #FFC107; }
  .text-cream-700 { color: #FFA000; }
  .border-cream-400 { border-color: #FFD54F; }
  .border-cream-500 { border-color: #FFCA28; }
  .hover\:bg-cream-500:hover { background-color: #FFCA28; }
  .hover\:bg-cream-600:hover { background-color: #FFC107; }
  .hover\:text-cream-600:hover { color: #FFC107; }
  .focus\:ring-cream-500:focus { --tw-ring-color: #FFCA28; }
  
  /* Colores rojo */
  .bg-red-500 { background-color: #dc6060; }
  .bg-red-600 { background-color: #E53935; }
  .bg-red-700 { background-color: #4c0909; }
  .text-red-500 { color: #F44336; }
  .text-red-600 { color: #E53935; }
  .border-red-500 { border-color: #F44336; }
  .border-red-600 { border-color: #E53935; }
  .hover\:bg-red-600:hover { background-color: #E53935; }
  .hover\:bg-red-700:hover { background-color: #461c1c; }
  
  /* Colores azul claro */
  .bg-lightblue-100 { background-color: #E1F5FE; }
  .bg-lightblue-200 { background-color: #B3E5FC; }
  .bg-lightblue-300 { background-color: #81D4FA; }
  .bg-lightblue-400 { background-color: #4ff7e3; }
  .bg-lightblue-500 { background-color: #29B6F6; }
  .bg-lightblue-600 { background-color: #03A9F4; }
  .text-lightblue-600 { color: #03A9F4; }
  .text-lightblue-700 { color: #0288D1; }
  .border-lightblue-400 { border-color: #4FC3F7; }
  .border-lightblue-500 { border-color: #29B6F6; }
  .hover\:bg-lightblue-500:hover { background-color: #29B6F6; }
  .hover\:bg-lightblue-600:hover { background-color: #03A9F4; }
  .hover\:text-lightblue-600:hover { color: #03A9F4; }
  .focus\:ring-lightblue-500:focus { --tw-ring-color: #29B6F6; }
</style>
</style>
{% endblock %}

{% block content %}
    <!-- Checkout Section -->
    <section class="py-8">
        <div class="container mx-auto px-4">
            <h1 class="text-3xl font-heading font-bold mb-8">Checkout</h1>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Checkout Form -->
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold mb-6">Shipping Information</h2>
                            
                            {% if shipping_addresses %}
                                <div class="mb-6">
                                    <h3 class="text-lg font-medium mb-3">Saved Addresses</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                        {% for address in shipping_addresses %}
                                            <div class="border rounded-md p-4 address-card {% if address.default %}selected{% endif %}" 
                                                data-address-id="{{ address.id }}"
                                                onclick="selectAddress(this, {{ address.id }})">
                                                <div class="flex justify-between items-start mb-2">
                                                    <h4 class="font-medium">{{ address.full_name }}</h4>
                                                    {% if address.default %}
                                                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                                            Default
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <p class="text-sm text-gray-600">{{ address.address }}</p>
                                                <p class="text-sm text-gray-600">{{ address.city }}, {{ address.state }} {{ address.postal_code }}</p>
                                                <p class="text-sm text-gray-600">{{ address.phone }}</p>
                                            </div>
                                        {% endfor %}
                                    </div>
                                    <div class="flex items-center mb-4">
                                        <span class="flex-grow border-t border-gray-200"></span>
                                        <span class="mx-4 text-sm text-gray-500">Or enter a new address</span>
                                        <span class="flex-grow border-t border-gray-200"></span>
                                    </div>
                                </div>
                            {% endif %}
                            
                            <form id="payment-form" class="needs-validation">
                                {% csrf_token %}
                                <input type="hidden" name="selected_address_id" id="selected_address_id" value="">
                                
                                <div class="grid grid-cols-1 gap-y-6 gap-x-4 sm:grid-cols-2">
                                    <div>
                                        <label for="full_name" class="block text-sm font-medium text-gray-700">Full Name *</label>
                                        <input type="text" name="full_name" id="full_name" required 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                        <div id="full_name_error" class="error-message"></div>
                                    </div>
                                    
                                    <div>
                                        <label for="email" class="block text-sm font-medium text-gray-700">Email *</label>
                                        <input type="email" name="email" id="email" required 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                        <div id="email_error" class="error-message"></div>
                                    </div>
                                    
                                    <div class="sm:col-span-2">
                                        <label for="address" class="block text-sm font-medium text-gray-700">Address *</label>
                                        <input type="text" name="address" id="address" required 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                        <div id="address_error" class="error-message"></div>
                                    </div>
                                    
                                    <div>
                                        <label for="city" class="block text-sm font-medium text-gray-700">City *</label>
                                        <input type="text" name="city" id="city" required 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                        <div id="city_error" class="error-message"></div>
                                    </div>
                                    
                                    <div>
                                        <label for="state" class="block text-sm font-medium text-gray-700">State/Province *</label>
                                        <input type="text" name="state" id="state" required 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                        <div id="state_error" class="error-message"></div>
                                    </div>
                                    
                                    <div>
                                        <label for="postal_code" class="block text-sm font-medium text-gray-700">Postal Code *</label>
                                        <input type="text" name="postal_code" id="postal_code" required 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                        <div id="postal_code_error" class="error-message"></div>
                                    </div>
                                    
                                    <div>
                                        <label for="phone" class="block text-sm font-medium text-gray-700">Phone *</label>
                                        <input type="tel" name="phone" id="phone" required 
                                               class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm py-2 px-3 focus:outline-none focus:ring-primary-500 focus:border-primary-500">
                                        <div id="phone_error" class="error-message"></div>
                                    </div>
                                </div>
                                
                                <div class="mt-8">
                                    <h3 class="text-lg font-medium mb-4">Payment Information</h3>
                                    
                                    <div class="mb-6">
                                        <div class="bg-gray-50 p-4 rounded-md mb-4">
                                            <p class="text-sm text-gray-600">
                                                <strong>Important:</strong> This is a test checkout. Use the following test card details:
                                            </p>
                                            <ul class="text-sm text-gray-600 mt-2 space-y-1">
                                                <li>Card Number: 4242 4242 4242 4242</li>
                                                <li>Expiration: Any future date</li>
                                                <li>CVC: Any 3 digits</li>
                                                <li>ZIP: Any 5 digits</li>
                                            </ul>
                                        </div>
                                        
                                        <div id="card-element" class="mt-1">
                                            <!-- Stripe Card Element will be inserted here -->
                                        </div>
                                        <div id="card-errors" class="text-red-600 text-sm mt-1" role="alert"></div>
                                    </div>
                                    
                                    <div class="bg-yellow-50 p-4 rounded-md mb-6">
                                        <h4 class="font-medium text-yellow-800">Shipping Notice</h4>
                                        <p class="text-sm text-yellow-700 mt-1">For your security, you are being redirected to a confirmation payment.</p>
                                        <p class="text-sm text-yellow-700 mt-1">Please note that delivery takes 15-30 business days. Your order will be processed and shipped as soon as possible.</p>
                                    </div>
                                </div>
                                
                                <div class="mt-6">
                                    <button id="submit-button" type="submit" class="w-full flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary-500">
                                        <span id="button-text">Pay Now</span>
                                        <div id="spinner" class="hidden">
                                            <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                            </svg>
                                        </div>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div class="lg:col-span-1">
                    <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                        <div class="p-6">
                            <h2 class="text-xl font-semibold mb-6">Order Summary</h2>
                            
                            <div class="border-b border-gray-200 pb-4 mb-4">
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">Subtotal</span>
                                    <span class="font-medium">${{ cart_total|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between mb-2">
                                    <span class="text-gray-600">Shipping</span>
                                    <span class="font-medium">${{ shipping_cost|floatformat:2 }}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-gray-600">Tax</span>
                                    <span class="font-medium">${{ tax|floatformat:2 }}</span>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center mb-6">
                                <span class="text-lg font-semibold">Total</span>
                                <span class="text-xl font-bold">${{ total|floatformat:2 }}</span>
                            </div>
                            
                            <div class="border-t border-gray-200 pt-4">
                                <h3 class="font-medium mb-3">Items in your order</h3>
                                <div class="space-y-4">
                                    {% for item in cart_items %}
                                    <div class="flex items-center">
                                        <div class="flex-shrink-0 h-16 w-16 rounded-md overflow-hidden border border-gray-200">
                                            <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="h-full w-full object-cover">
                                        </div>
                                        <div class="ml-4 flex-1">
                                            <h4 class="text-sm font-medium">{{ item.product.name }}</h4>
                                            <p class="text-sm text-gray-600">Qty: {{ item.quantity }}</p>
                                        </div>
                                        <div class="ml-4">
                                            <p class="text-sm font-medium">${{ item.total_price|floatformat:2 }}</p>
                                        </div>
                                    </div>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script src="https://js.stripe.com/v3/"></script>
<script>
    // Función para seleccionar dirección
    function selectAddress(element, addressId) {
        // Desmarcar todas las tarjetas de dirección
        document.querySelectorAll('.address-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Marcar la seleccionada
        element.classList.add('selected');
        
        // Actualizar el campo oculto
        document.getElementById('selected_address_id').value = addressId;
        
        // Llenar automáticamente el formulario con los datos de la dirección
        fetch(`/get_address_details/${addressId}/`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    document.getElementById('full_name').value = data.address.full_name;
                    document.getElementById('email').value = data.address.email || '';
                    document.getElementById('address').value = data.address.address;
                    document.getElementById('city').value = data.address.city;
                    document.getElementById('state').value = data.address.state;
                    document.getElementById('postal_code').value = data.address.postal_code;
                    document.getElementById('phone').value = data.address.phone;
                }
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Función para obtener el token CSRF
        function getCSRFToken() {
            return document.querySelector('[name=csrfmiddlewaretoken]').value;
        }

        // Initialize Stripe
        const stripe = Stripe('{{ stripe_public_key }}');
        const elements = stripe.elements();
        
        // Create and mount the Card Element
        const style = {
            base: {
                color: '#4b5563',
                fontFamily: '"Inter", sans-serif',
                fontSmoothing: 'antialiased',
                fontSize: '16px',
                '::placeholder': {
                    color: '#9ca3af'
                }
            },
            invalid: {
                color: '#ef4444',
                iconColor: '#ef4444'
            }
        };
        
        const card = elements.create('card', { style: style });
        card.mount('#card-element');
        
        // Handle real-time validation errors
        card.addEventListener('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
                displayError.style.display = 'block';
            } else {
                displayError.textContent = '';
                displayError.style.display = 'none';
            }
        });
        
        // Validación del formulario
        function validateForm() {
            let isValid = true;
            const requiredFields = [
                'full_name', 'email', 'address', 
                'city', 'state', 'postal_code', 'phone'
            ];
            
            requiredFields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                const errorElement = document.getElementById(`${fieldId}_error`);
                
                if (!field.value.trim()) {
                    errorElement.textContent = 'This field is required';
                    isValid = false;
                } else {
                    errorElement.textContent = '';
                    
                    // Validación específica para email
                    if (fieldId === 'email' && !/^\S+@\S+\.\S+$/.test(field.value)) {
                        errorElement.textContent = 'Please enter a valid email address';
                        isValid = false;
                    }
                    
                    // Validación específica para teléfono
                    if (fieldId === 'phone' && !/^[\d\s\+\-\(\)]{6,}$/.test(field.value)) {
                        errorElement.textContent = 'Please enter a valid phone number';
                        isValid = false;
                    }
                }
            });
            
            return isValid;
        }
        
        // Handle form submission
        const form = document.getElementById('payment-form');
        form.addEventListener('submit', function(event) {
            event.preventDefault();
            
            // Validar el formulario antes de proceder
            if (!validateForm()) {
                return;
            }
            
            // Disable the submit button to prevent repeated clicks
            const submitButton = document.getElementById('submit-button');
            const buttonText = document.getElementById('button-text');
            const spinner = document.getElementById('spinner');
            
            submitButton.disabled = true;
            buttonText.textContent = 'Processing...';
            spinner.classList.remove('hidden');
            
            // Collect form data
            const formData = new FormData(form);
            const formObject = {};
            
            formData.forEach((value, key) => {
                formObject[key] = value;
            });
            
            // Get CSRF token
            const csrfToken = getCSRFToken();
            if (!csrfToken) {
                console.error('CSRF token not found');
                showError('Security error. Please refresh the page and try again.');
                resetButton();
                return;
            }
            
            // Create checkout session on the server
            fetch('{% url "checkout" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(formObject)
            })
            .then(function(response) {
                if (!response.ok) {
                    return response.json().then(err => { throw err; });
                }
                return response.json();
            })
            .then(function(data) {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Si el pago es exitoso, redirigir a la página de confirmación
                if (data.success) {
                    window.location.href = `{% url 'payment_success' %}?session_id=${data.session_id}`;
                } else if (data.session_id) {
                    // Redirigir a Stripe Checkout si es necesario
                    return stripe.redirectToCheckout({ sessionId: data.session_id });
                } else {
                    throw new Error('Unexpected response from server');
                }
            })
            .catch(function(error) {
                console.error('Error:', error);
                showError(error.message || 'An unexpected error occurred. Please try again.');
            })
            .finally(function() {
                resetButton();
            });
            
            function showError(message) {
                const errorElement = document.getElementById('card-errors');
                errorElement.textContent = message;
                errorElement.style.display = 'block';
            }
            
            function resetButton() {
                submitButton.disabled = false;
                buttonText.textContent = 'Pay Now';
                spinner.classList.add('hidden');
            }
        });
        
        // Seleccionar la dirección por defecto al cargar la página
        const defaultAddress = document.querySelector('.address-card.selected');
        if (defaultAddress) {
            const addressId = defaultAddress.getAttribute('data-address-id');
            document.getElementById('selected_address_id').value = addressId;
        }
    });
</script>
{% endblock %}